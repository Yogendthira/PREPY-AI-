<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prepy AI - Performance Review Dashboard</title>
    <link rel="icon" type="image/png" href="FAVICON.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="reviewdashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <img src="LOGO PLAIN.png" alt="Prepy AI Logo" class="header-logo">
            <h1>Performance Review Dashboard</h1>
            <p>Comprehensive analysis of your interview/hackathon session</p>
        </div>

        <!-- Overall Score -->
        <div class="overall-score">
            <div class="score-label">Overall Performance Score</div>
            <div class="score-circle" style="--score-percent: 0%">
                <div class="score-value" id="overallScore">--</div>
            </div>
            <div class="performance-grade" id="performanceGrade">Analyzing...</div>
        </div>

        <!-- Performance Metrics Grid -->
        <div class="metrics-grid">
            <!-- English Skills -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">üó£Ô∏è English Communication</div>
                    <div class="metric-score" id="englishScore">--</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="metric-details">
                    <li>Grammar & Vocabulary: --</li>
                    <li>Pronunciation: --</li>
                    <li>Sentence Structure: --</li>
                    <li>Fluency: --</li>
                </ul>
            </div>

            <!-- Technical Performance -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">üíª Technical Skills</div>
                    <div class="metric-score" id="technicalScore">--</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="metric-details">
                    <li>Problem-solving: --</li>
                    <li>Code Quality: --</li>
                    <li>Technical Knowledge: --</li>
                    <li>Debugging Skills: --</li>
                </ul>
            </div>

            <!-- Communication Skills -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">üí¨ Communication</div>
                    <div class="metric-score" id="communicationScore">--</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="metric-details">
                    <li>Clarity of Expression: --</li>
                    <li>Active Listening: --</li>
                    <li>Articulation: --</li>
                    <li>Response Time: --</li>
                </ul>
            </div>

            <!-- Team Collaboration -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">ü§ù Team Collaboration</div>
                    <div class="metric-score" id="teamScore">--</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="metric-details">
                    <li>Teamwork: --</li>
                    <li>Leadership: --</li>
                    <li>Conflict Resolution: --</li>
                    <li>Contribution: --</li>
                </ul>
            </div>

            <!-- Soft Skills -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">üåü Soft Skills</div>
                    <div class="metric-score" id="softSkillsScore">--</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="metric-details">
                    <li>Confidence: --</li>
                    <li>Time Management: --</li>
                    <li>Adaptability: --</li>
                    <li>Creativity: --</li>
                </ul>
            </div>

            <!-- Project Performance -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">üöÄ Project Quality</div>
                    <div class="metric-score" id="projectScore">--</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="metric-details">
                    <li>Completeness: --</li>
                    <li>Innovation: --</li>
                    <li>Functionality: --</li>
                    <li>Presentation: --</li>
                </ul>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-title">Skills Radar Chart</div>
                <canvas id="radarChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Performance Breakdown</div>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Bottom Section: Chat & Feedback -->
        <div class="bottom-grid">
            <!-- Conversation History Section -->
            <div class="feedback-section chat-section">
                <h2>üí¨ Conversation History</h2>
                <div class="conversation-container scrollable-box" id="conversationContainer">
                    <p style="color: #888; text-align: center; padding: 40px;">No conversation history available.</p>
                </div>
            </div>

            <!-- Detailed Feedback -->
            <div class="feedback-section">
                <h2>üìù Detailed Feedback & Recommendations</h2>

                <div class="feedback-content scrollable-box">
                    <div class="feedback-item">
                        <h3>Strengths</h3>
                        <p>Loading feedback...</p>
                    </div>

                    <div class="feedback-item">
                        <h3>Areas for Improvement</h3>
                        <p>Loading feedback...</p>
                    </div>

                    <div class="feedback-item">
                        <h3>English Language Assessment</h3>
                        <p>Loading feedback...</p>
                    </div>

                    <div class="feedback-item">
                        <h3>Recommendations</h3>
                        <p>Loading feedback...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="controls">
            <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Print Report</button>
            <a href="index.html" class="btn btn-secondary">üè† Back to Home</a>
            <a href="main.html" class="btn btn-secondary">üîÑ New Session</a>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; display: none;">
        <div
            style="width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #00ff41; border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
        <h2 style="color: #00ff41; margin-top: 20px;">Generating Performance Report...</h2>
        <p style="color: #888;">Analyzing your conversation history</p>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        // Load conversation history
        const conversationHistory = JSON.parse(sessionStorage.getItem('conversationHistory') || '[]');
        const conversationContainer = document.getElementById('conversationContainer');

        // Display Chat History
        if (conversationHistory.length > 0) {
            conversationContainer.innerHTML = '';
            conversationHistory.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'feedback-item';
                messageDiv.style.marginBottom = '15px';

                const role = msg.role === 'assistant' ? 'AI' : 'You';
                const icon = msg.role === 'assistant' ? 'ü§ñ' : 'üë§';

                messageDiv.innerHTML = `
                    <h3>${icon} ${role}</h3>
                    <p>${msg.content}</p>
                `;
                conversationContainer.appendChild(messageDiv);
            });
        }

        // Initialize Charts (Empty initially)
        let radarChart, barChart;

        function initCharts() {
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['English', 'Technical', 'Communication', 'Teamwork', 'Soft Skills', 'Project'],
                    datasets: [{
                        label: 'Performance Scores',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(0, 255, 65, 0.2)',
                        borderColor: '#00ff41',
                        borderWidth: 2,
                        pointBackgroundColor: '#00ff41',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#888', backdropColor: 'transparent' },
                            grid: { color: '#333' },
                            pointLabels: { color: '#fff', font: { size: 12 } }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['English', 'Technical', 'Communication', 'Teamwork', 'Soft Skills', 'Project'],
                    datasets: [{
                        label: 'Score',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(0, 255, 65, 0.8)', 'rgba(0, 212, 255, 0.8)', 'rgba(123, 47, 247, 0.8)',
                            'rgba(255, 159, 64, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)'
                        ],
                        borderColor: [
                            '#00ff41', '#00d4ff', '#7b2ff7', '#ff9f40', '#ff6384', '#4bc0c0'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        initCharts();

        // Function to update UI with data
        function updateDashboard(data) {
            const scores = data.scores;
            const feedback = data.feedback;

            // Update Scores
            document.getElementById('overallScore').textContent = scores.overall;
            document.querySelector('.score-circle').style.setProperty('--score-percent', scores.overall + '%');
            document.getElementById('performanceGrade').textContent = getGrade(scores.overall);

            document.getElementById('englishScore').textContent = scores.english;
            document.querySelectorAll('.progress-fill')[0].style.width = scores.english + '%';

            document.getElementById('technicalScore').textContent = scores.technical;
            document.querySelectorAll('.progress-fill')[1].style.width = scores.technical + '%';

            document.getElementById('communicationScore').textContent = scores.communication;
            document.querySelectorAll('.progress-fill')[2].style.width = scores.communication + '%';

            document.getElementById('teamScore').textContent = scores.teamwork;
            document.querySelectorAll('.progress-fill')[3].style.width = scores.teamwork + '%';

            document.getElementById('softSkillsScore').textContent = scores.soft_skills;
            document.querySelectorAll('.progress-fill')[4].style.width = scores.soft_skills + '%';

            document.getElementById('projectScore').textContent = scores.project;
            document.querySelectorAll('.progress-fill')[5].style.width = scores.project + '%';

            // Update Feedback
            const feedbackContainer = document.querySelector('.feedback-content');
            feedbackContainer.innerHTML = `
                <div class="feedback-item">
                    <h3>Strengths</h3>
                    <p>${feedback.strengths}</p>
                </div>
                <div class="feedback-item">
                    <h3>Areas for Improvement</h3>
                    <p>${feedback.improvements}</p>
                </div>
                <div class="feedback-item">
                    <h3>English Language Assessment</h3>
                    <p>${feedback.english_assessment}</p>
                </div>
                <div class="feedback-item">
                    <h3>Recommendations</h3>
                    <p>${feedback.recommendations}</p>
                </div>
            `;

            // Update Charts
            const newData = [scores.english, scores.technical, scores.communication, scores.teamwork, scores.soft_skills, scores.project];

            radarChart.data.datasets[0].data = newData;
            radarChart.update();

            barChart.data.datasets[0].data = newData;
            barChart.update();
        }

        function getGrade(score) {
            if (score >= 90) return 'Outstanding';
            if (score >= 80) return 'Excellent';
            if (score >= 70) return 'Good';
            if (score >= 60) return 'Satisfactory';
            return 'Needs Improvement';
        }

        // Fetch Analysis Data
        async function fetchAnalysis(port = 5000) {
            const storedData = sessionStorage.getItem('analysisData');

            if (storedData) {
                console.log("Using stored analysis data");
                updateDashboard(JSON.parse(storedData));
                return;
            }

            if (conversationHistory.length === 0) {
                console.warn("No conversation history to analyze");
                return;
            }

            // Show Loader only on first attempt
            if (port === 5000) {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            try {
                const response = await fetch(`http://127.0.0.1:${port}/api/analyze-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        history: conversationHistory,
                        job_role: "Candidate"
                    })
                });

                const result = await response.json();

                if (result.success) {
                    sessionStorage.setItem('analysisData', JSON.stringify(result.data));
                    updateDashboard(result.data);
                    document.getElementById('loadingOverlay').style.display = 'none';
                } else {
                    console.error("Analysis failed:", result.error);
                    alert("Failed to generate report. Please try again.");
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            } catch (error) {
                console.error(`Error connecting to server on port ${port}:`, error);

                // Retry on port 8000 if 5000 failed
                if (port === 5000) {
                    console.log("Retrying on port 8000...");
                    fetchAnalysis(8000);
                } else {
                    alert("Error connecting to analysis server. Please ensure 'python app.py' is running.");
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            }
        }

        // Start Analysis
        fetchAnalysis();
    </script>
</body>

</html>