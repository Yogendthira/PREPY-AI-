<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - Prepy AI</title>
    <link rel="icon" type="image/png" href="FAVICON.png">
    <link rel="stylesheet" href="upload.css?v=4">
</head>

<body>
    <div class="upload-container">
        <!-- Left Side: Difficulty Image -->
        <div class="difficulty-display">
            <img id="difficultyImage" src="" alt="Difficulty Mode">
        </div>

        <!-- Right Side: Upload Box -->
        <div class="upload-section">
            <h1 id="uploadTitle">Upload Your Resume</h1>
            <p class="subtitle" id="uploadSubtitle">Select your file to begin the evaluation</p>

            <div class="upload-box">
                <div class="upload-area" id="uploadArea">
                    <div class="icon-container">
                        <svg class="upload-icon" width="40" height="40" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <h3>Drag & Drop your file here</h3>
                    <p>or click to browse</p>
                    <span class="file-types">PDF, PPT, PPTX (Max 50MB)</span>
                    <input type="file" id="fileInput" accept=".pdf,.ppt,.pptx" hidden>
                </div>

                <div class="file-info" id="fileInfo" style="display: none;">
                    <div class="file-details">
                        <div class="file-icon-wrapper">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                        </div>
                        <div class="file-text">
                            <p class="file-name" id="fileName"></p>
                            <p class="file-size" id="fileSize"></p>
                        </div>
                    </div>
                    <button class="remove-btn" id="removeBtn">Remove File</button>
                </div>

                <button class="start-btn" id="startBtn" disabled>
                    <span id="btnText">Start Evaluation</span>
                    <div class="loader" id="btnLoader" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'superman';
        const prepType = urlParams.get('type') || 'interview';

        // Set difficulty image based on mode
        const modeImages = {
            'superman': 'SUPERMAN MODE.png',
            'batman': 'BATMAN MODE.png',
            'hulk': 'HULK MODE.png'
        };
        document.getElementById('difficultyImage').src = modeImages[mode];

        // Set upload title based on prep type
        if (prepType === 'interview') {
            document.getElementById('uploadTitle').textContent = 'Upload Your Resume';
            document.getElementById('uploadSubtitle').textContent = 'Select your resume to begin the interview evaluation';
        } else if (prepType === 'hackathon') {
            document.getElementById('uploadTitle').textContent = 'Upload Your Presentation';
            document.getElementById('uploadSubtitle').textContent = 'Upload your project presentation or idea document';
        }

        // File handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const startBtn = document.getElementById('startBtn');
        let selectedFile = null;

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        document.getElementById('removeBtn').addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            startBtn.disabled = true;
        });

        function handleFile(file) {
            const validTypes = ['application/pdf', 'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation'];

            if (!validTypes.includes(file.type)) {
                alert('Please upload a PDF, PPT, or PPTX file');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                alert('File size must be less than 50MB');
                return;
            }

            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);

            uploadArea.style.display = 'none';
            fileInfo.style.display = 'flex';
            startBtn.disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        startBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            startBtn.disabled = true;
            document.getElementById('btnText').style.display = 'none';
            document.getElementById('btnLoader').style.display = 'block';

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('type', prepType);
            formData.append('mode', mode);

            try {
                const response = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('prepySession', JSON.stringify({
                        sessionData: data.session_data,
                        history: [{ role: 'assistant', content: data.message }]
                    }));
                    window.location.href = `main.html?type=${prepType}&mode=${mode}`;
                } else {
                    alert('Error: ' + (data.error || 'Upload failed'));
                    startBtn.disabled = false;
                    document.getElementById('btnText').style.display = 'inline';
                    document.getElementById('btnLoader').style.display = 'none';
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload file. Make sure the backend server is running on http://localhost:5000');
                startBtn.disabled = false;
                document.getElementById('btnText').style.display = 'inline';
                document.getElementById('btnLoader').style.display = 'none';
            }
        });
    </script>
</body>

</html>